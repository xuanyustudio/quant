# 账户余额显示功能更新 💰

## ✨ 新功能

实盘交易输出中现在会自动显示**现货和合约账户的余额**，让您更全面地了解账户状态！

---

## 🎯 功能说明

### 1. 启动时显示初始余额

当实盘交易启动时，会显示：

```
📊 初始账户状态:
💰 账户余额:
   📍 现货账户:
      • USDT 总额: $1,234.56
      • 可用: $1,000.00
      • 占用: $234.56
   📍 合约账户:
      • USDT 总额: $5,678.90
      • 可用: $5,000.00
      • 占用: $678.90
   💎 总资产: $6,913.46
```

### 2. 每个检查周期显示余额

每次检查交易信号后，都会显示当前的账户余额：

```
════════════════════════════════════════════════════════════
💰 账户余额:
   📍 现货账户:
      • USDT 总额: $1,234.56
      • 可用: $1,000.00
      • 占用: $234.56
   📍 合约账户:
      • USDT 总额: $5,678.90
      • 可用: $5,000.00
      • 占用: $678.90
   💎 总资产: $6,913.46
📊 累计统计:
   总交易次数: 5
   胜率: 60.0%
   总盈亏: +123.45 USDT
⏰ 等待 60 秒后进行下一次检查...
   下次检查时间: 2025/10/30 12:34:56
════════════════════════════════════════════════════════════
```

---

## 📋 显示内容

### 现货账户
- ✅ USDT 总额（total）
- ✅ 可用余额（free）
- ✅ 占用余额（used，处于挂单或持仓状态）

### 合约账户
- ✅ USDT 总额（total）
- ✅ 可用余额（free）
- ✅ 占用余额（used，保证金和持仓占用）

### 总资产
- ✅ 现货 + 合约的总 USDT 余额

---

## 🔧 技术实现

### 新增方法

#### 1. `fetchAccountBalance()`
查询现货和合约账户余额

```javascript
async fetchAccountBalance() {
  // 查询现货账户
  const spotBalance = await this.exchange.fetchBalance({ type: 'spot' });
  
  // 查询合约账户
  const futuresBalance = await this.exchange.fetchBalance({ type: 'future' });
  
  return { spot, futures };
}
```

#### 2. `displayAccountBalance()`
格式化显示账户余额信息

```javascript
async displayAccountBalance() {
  const balances = await this.fetchAccountBalance();
  
  logger.info('💰 账户余额:');
  logger.info('   📍 现货账户:');
  logger.info(`      • USDT 总额: $${balances.spot.usdt.toFixed(2)}`);
  // ...
}
```

### 调用位置

1. **启动时**（第735-736行）
   ```javascript
   logger.info('📊 初始账户状态:');
   await this.displayAccountBalance();
   ```

2. **主循环中**（第928-930行）
   ```javascript
   logger.info('═'.repeat(60));
   await this.displayAccountBalance();
   ```

---

## 🎨 日志输出示例

### 完整的检查周期输出

```
════════════════════════════════════════════════════════════
🔍 第 5 次检查 [2025/10/30 12:34:56]
════════════════════════════════════════════════════════════

────────────────────────────────────────────────────────────
📊 MINA/USDT / POLYX/USDT [2025/10/30 12:34:56]
   💰 当前价格: MINA/USDT=$0.10140000 | POLYX/USDT=$0.08460000
   📈 价格比率: 1.1986
   📊 相关系数: 0.977 ✨
   📉 价差统计: 当前=0.985275 | 均值=1.005103 | 标准差=0.008454
   🎯 Z-Score: -2.44 🔥
   📏 阈值: 开仓=3.1 | 平仓=0.6 | 止损=4.75
   ⏸️ 信号: HOLD - 观望: Z=-2.44
   💼 持仓状态: 无持仓

════════════════════════════════════════════════════════════
💰 账户余额:
   📍 现货账户:
      • USDT 总额: $1,234.56
      • 可用: $1,000.00
      • 占用: $234.56
   📍 合约账户:
      • USDT 总额: $5,678.90
      • 可用: $5,000.00
      • 占用: $678.90
   💎 总资产: $6,913.46
📊 累计统计:
   总交易次数: 5
   胜率: 60.0%
   总盈亏: +123.45 USDT
⏰ 等待 60 秒后进行下一次检查...
   下次检查时间: 2025/10/30 12:35:56
════════════════════════════════════════════════════════════
```

---

## 💡 使用建议

### 1. 监控资金变化

通过对比每次检查周期的余额变化，可以：
- ✅ 验证交易是否成功执行
- ✅ 发现异常的资金变动
- ✅ 跟踪实际盈亏情况

### 2. 检查账户健康

关注以下指标：
- **占用余额过高**：可能持仓过多或有大量挂单
- **可用余额不足**：需要及时补充资金
- **总资产下降**：策略可能在亏损

### 3. 对比交易统计

将账户余额变化与交易统计对比：
```
总盈亏: +123.45 USDT
总资产变化: $6,789.00 → $6,913.46 (+$124.46)
```

如果两者不一致，可能有：
- 手续费扣除
- 其他交易影响
- 资金转入转出

---

## ⚠️ 注意事项

### 1. API 权限

确保您的币安 API 具有以下权限：
- ✅ **读取现货账户**（Spot Account/Read）
- ✅ **读取合约账户**（Futures Account/Read）

### 2. 查询频率

- 每个检查周期查询一次余额
- 默认周期：60秒
- 不会导致 API 限速

### 3. 网络延迟

如果看到警告：
```
⚠️  查询现货余额失败: Request timeout
⚠️  查询合约余额失败: Request timeout
```

可能原因：
- 网络不稳定
- API 响应慢
- 代理问题

不影响主要交易逻辑，下次检查会重试。

---

## 🔍 故障排查

### 问题1：显示"未查询到余额"

**可能原因**：
1. API 密钥没有读取权限
2. 账户类型不匹配
3. 账户中确实没有 USDT

**解决方案**：
```bash
# 检查 API 权限
# 访问：https://www.binance.com/zh-CN/my/settings/api-management

# 确保勾选：
# ✅ 读取权限（Enable Reading）
# ✅ 现货和杠杆交易（Enable Spot & Margin Trading）
# ✅ 合约交易（Enable Futures）
```

### 问题2：查询失败

```
查询账户余额失败: Invalid API-key, IP, or permissions
```

**解决方案**：
1. 检查服务器 IP 是否在白名单
2. 检查 API Key 是否正确
3. 检查 API 权限是否足够

### 问题3：余额不准确

**可能原因**：
- 其他账户类型的资金（杠杆、理财等）
- 简化处理只统计 USDT

**完整统计方案**（后续优化）：
- 查询所有币种
- 转换为 USDT 等值
- 包含杠杆、理财等账户

---

## 🚀 后续优化计划

### 1. 更详细的资产统计
- [ ] 显示所有币种余额（不仅 USDT）
- [ ] 计算总资产的 USDT 等值
- [ ] 包含杠杆、理财账户

### 2. 资金变化追踪
- [ ] 记录初始资金
- [ ] 计算资金变化率
- [ ] 图表展示资金曲线

### 3. 预警功能
- [ ] 余额过低预警
- [ ] 异常变动预警
- [ ] 发送通知（微信/邮件）

### 4. 持仓明细
- [ ] 显示当前持仓币种和数量
- [ ] 显示持仓成本和浮动盈亏
- [ ] 持仓占比分析

---

## 📝 修改文件

- ✅ `src/statistical-arbitrage/index.js`
  - 新增 `fetchAccountBalance()` 方法
  - 新增 `displayAccountBalance()` 方法
  - 在 `runLive()` 启动时调用
  - 在主循环每次检查后调用

---

## 🎉 使用效果

现在您可以：

1. **启动时**：看到初始账户余额，确认资金状态
2. **运行中**：每分钟自动显示余额，实时监控
3. **交易后**：立即看到余额变化，验证交易执行
4. **统计对比**：余额变化 vs 交易盈亏，数据对齐

**让实盘交易更加透明、可控！** 💪

---

## 🌟 示例场景

### 场景1：开仓前
```
💰 账户余额:
   📍 合约账户:
      • USDT 总额: $10,000.00
      • 可用: $10,000.00
      • 占用: $0.00
```

### 场景2：开仓后
```
💰 账户余额:
   📍 合约账户:
      • USDT 总额: $10,000.00
      • 可用: $9,000.00
      • 占用: $1,000.00  ← 1000 USDT 用作保证金
```

### 场景3：平仓盈利
```
💰 账户余额:
   📍 合约账户:
      • USDT 总额: $10,050.00  ← 盈利 $50
      • 可用: $10,050.00
      • 占用: $0.00
📊 累计统计:
   总盈亏: +50.00 USDT  ← 与余额变化一致 ✅
```

---

**🎊 现在您可以更全面地监控实盘交易状态了！**

