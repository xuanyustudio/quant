#!/bin/bash

###############################################################################
# å¿«é€Ÿæ›´æ–°å¹¶é‡å¯å®ç›˜äº¤æ˜“ç³»ç»Ÿ
###############################################################################

echo "ğŸ”„ æ›´æ–°å®ç›˜äº¤æ˜“ç³»ç»Ÿ"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# 1. åœæ­¢è¿è¡Œä¸­çš„è¿›ç¨‹
echo "â¸ï¸  åœæ­¢å½“å‰è¿›ç¨‹..."
pm2 stop stat-arb 2>/dev/null

if [ $? -eq 0 ]; then
    echo "âœ… è¿›ç¨‹å·²åœæ­¢"
else
    echo "âš ï¸  æœªå‘ç°è¿è¡Œä¸­çš„è¿›ç¨‹"
fi
echo ""

# 2. æ›´æ–°ä»£ç ï¼ˆå¦‚æœä½¿ç”¨Gitï¼‰
if [ -d ".git" ]; then
    echo "ğŸ“¥ ä»Gitæ‹‰å–æœ€æ–°ä»£ç ..."
    git pull
    if [ $? -eq 0 ]; then
        echo "âœ… ä»£ç æ›´æ–°æˆåŠŸ"
    else
        echo "âŒ ä»£ç æ›´æ–°å¤±è´¥"
        echo "   æ‰‹åŠ¨æ›´æ–°åï¼Œè¿è¡Œ: pm2 restart stat-arb"
        exit 1
    fi
else
    echo "âš ï¸  æœªæ£€æµ‹åˆ°Gitä»“åº“ï¼Œè·³è¿‡ä»£ç æ‹‰å–"
    echo "   è¯·æ‰‹åŠ¨ä¸Šä¼ æœ€æ–°ä»£ç æ–‡ä»¶"
fi
echo ""

# 3. æ£€æŸ¥è¯­æ³•ï¼ˆå¯é€‰ï¼‰
echo "ğŸ” æ£€æŸ¥ä»£ç è¯­æ³•..."
node --check src/statistical-arbitrage/index.js
if [ $? -ne 0 ]; then
    echo "âŒ ä»£ç è¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥"
    exit 1
fi
echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"
echo ""

# 4. é‡å¯è¿›ç¨‹
echo "ğŸš€ é‡å¯è¿›ç¨‹..."
pm2 restart stat-arb

if [ $? -ne 0 ]; then
    echo "âŒ é‡å¯å¤±è´¥ï¼Œå°è¯•é‡æ–°å¯åŠ¨..."
    pm2 start ecosystem.config.cjs
fi

echo ""
echo "âœ… æ›´æ–°å®Œæˆï¼"
echo ""

# 5. æ˜¾ç¤ºçŠ¶æ€
echo "ğŸ“Š å½“å‰çŠ¶æ€ï¼š"
pm2 list

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ’¡ æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼š"
echo "   pm2 logs stat-arb"
echo ""
echo "   æˆ–è¿è¡Œ: pm2 logs stat-arb --lines 50"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# 6. è¯¢é—®æ˜¯å¦æŸ¥çœ‹æ—¥å¿—
echo "â“ æ˜¯å¦ç«‹å³æŸ¥çœ‹æ—¥å¿—ï¼Ÿ(y/n)"
read -r answer
if [ "$answer" == "y" ] || [ "$answer" == "Y" ]; then
    pm2 logs stat-arb
fi

